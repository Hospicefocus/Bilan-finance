<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üí∞ Syst√®me Financier Personnel</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    .auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 1rem; }
    .auth-card { background: white; border-radius: 1rem; box-shadow: 0 20px 60px rgba(0,0,0,0.3); padding: 2rem; max-width: 400px; width: 100%; }
    .auth-card h1 { font-size: 2rem; margin-bottom: 0.5rem; text-align: center; }
    .auth-card p { text-align: center; color: #6b7280; margin-bottom: 2rem; }
    .container { max-width: 1152px; margin: 0 auto; padding: 1rem; display: none; }
    .container.show { display: block; }
    .card { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1rem; }
    .header { background: white; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 1.875rem; font-weight: bold; color: #1f2937; }
    .header p { color: #6b7280; margin-top: 0.25rem; }
    .logout-btn { padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; }
    .logout-btn:hover { background: #dc2626; }
    .tabs { background: white; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 0.5rem; margin-bottom: 1.5rem; display: flex; gap: 0.5rem; overflow-x: auto; }
    .tab { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; border: none; cursor: pointer; background: #f3f4f6; color: #374151; white-space: nowrap; }
    .tab.active { background: #3b82f6; color: white; }
    .banner { border-radius: 0.75rem; padding: 1.5rem; color: white; margin-bottom: 1rem; }
    .banner.blue { background: #3b82f6; }
    .banner.purple { background: #9333ea; }
    .banner.orange { background: #ea580c; }
    .banner.gray { background: #374151; }
    .banner h2 { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; }
    .form-input, .form-select { width: 100%; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; font-size: 1rem; }
    .form-input:focus, .form-select:focus { outline: none; border-color: #3b82f6; }
    .grid { display: grid; gap: 1rem; }
    .grid-2 { grid-template-columns: 1fr; }
    @media (min-width: 768px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
    .grid-3 { grid-template-columns: 1fr; }
    @media (min-width: 768px) { .grid-3 { grid-template-columns: repeat(3, 1fr); } }
    .btn { width: 100%; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: bold; border: none; cursor: pointer; font-size: 1rem; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-secondary { background: #6b7280; color: white; }
    .btn-secondary:hover { background: #4b5563; }
    .stat-card { background: white; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 1.5rem; }
    .stat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .stat-value { font-size: 1.875rem; font-weight: bold; }
    .text-green { color: #16a34a; }
    .text-red { color: #dc2626; }
    .text-blue { color: #2563eb; }
    .text-gray { color: #6b7280; }
    .transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem; margin-bottom: 0.5rem; border-left: 4px solid #e5e7eb; }
    .transaction-left { flex: 1; }
    .transaction-date { font-weight: 600; margin-bottom: 0.25rem; }
    .transaction-detail { font-size: 0.875rem; color: #6b7280; }
    .transaction-category { display: inline-block; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; margin-top: 0.25rem; }
    .transaction-right { text-align: right; margin-right: 0.5rem; }
    .transaction-delete { background: none; border: none; color: #dc2626; font-size: 1.5rem; cursor: pointer; padding: 0 0.5rem; }
    .list-container { max-height: 384px; overflow-y: auto; }
    .empty-state { text-align: center; color: #9ca3af; padding: 2rem; }
    .alert { padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; font-weight: 600; }
    .alert.success { background: #d1fae5; color: #065f46; }
    .alert.warning { background: #fef3c7; color: #92400e; }
    .alert.danger { background: #fee2e2; color: #991b1b; }
    .category-stat { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f9fafb; border-radius: 0.5rem; margin-bottom: 0.5rem; border-left: 4px solid; }
    .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-top: 0.5rem; }
    .progress-fill { height: 100%; background: #3b82f6; transition: width 0.3s; }
    .loading { text-align: center; padding: 2rem; color: #6b7280; }
    .error { background: #fee2e2; color: #991b1b; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <!-- Auth Container -->
  <div id="authContainer" class="auth-container">
    <div class="auth-card">
      <h1>üí∞ Finances</h1>
      <p>Connecte-toi pour acc√©der √† tes donn√©es</p>
      
      <div id="authError" class="error" style="display: none;"></div>
      
      <div id="loginForm">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="loginEmail" class="form-input" placeholder="ton@email.com">
        </div>
        <div class="form-group">
          <label>Mot de passe</label>
          <input type="password" id="loginPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button onclick="login()" class="btn btn-primary" style="margin-bottom: 0.5rem;">Se connecter</button>
        <button onclick="showSignup()" class="btn btn-secondary">Cr√©er un compte</button>
      </div>

      <div id="signupForm" style="display: none;">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="signupEmail" class="form-input" placeholder="ton@email.com">
        </div>
        <div class="form-group">
          <label>Mot de passe (min 6 caract√®res)</label>
          <input type="password" id="signupPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button onclick="signup()" class="btn btn-primary" style="margin-bottom: 0.5rem;">Cr√©er mon compte</button>
        <button onclick="showLogin()" class="btn btn-secondary">Retour √† la connexion</button>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="container">
    <div class="header">
      <div>
        <h1>üí∞ Syst√®me Financier Personnel</h1>
        <p>Plan 40/10/10/20/10/10 ‚Ä¢ <span id="currencyDisplay">FCFA</span> ‚Ä¢ <span id="userEmail"></span></p>
      </div>
      <button onclick="logout()" class="logout-btn">D√©connexion</button>
    </div>

    <div class="tabs">
      <button onclick="showPage('saisie')" id="btnSaisie" class="tab active">üìù Saisie</button>
      <button onclick="showPage('dashboard')" id="btnDashboard" class="tab">üìä Dashboard</button>
      <button onclick="showPage('settings')" id="btnSettings" class="tab">‚öôÔ∏è Param√®tres</button>
    </div>

    <div id="pageSaisie">
      <div class="banner blue">
        <h2>Saisie Quotidienne</h2>
        <p>Enregistre tes transactions en 2 minutes</p>
      </div>

      <div class="card">
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="dateInput" class="form-input">
        </div>

        <div class="grid grid-2">
          <div class="form-group">
            <label>üí∞ Entr√©e (<span class="currency">FCFA</span>)</label>
            <input type="number" id="entreeInput" placeholder="Montant re√ßu" class="form-input" step="0.01">
          </div>
          <div class="form-group">
            <label>üì¶ Source</label>
            <input type="text" id="sourceInput" placeholder="D'o√π vient l'argent" class="form-input">
          </div>
        </div>

        <div class="grid grid-2">
          <div class="form-group">
            <label>üí∏ Sortie (<span class="currency">FCFA</span>)</label>
            <input type="number" id="sortieInput" placeholder="Montant d√©pens√©" class="form-input" step="0.01">
          </div>
          <div class="form-group">
            <label>üè∑Ô∏è Cat√©gorie</label>
            <select id="categoryInput" class="form-select">
              <option value="">-- Choisir --</option>
              <option value="alimentation">üçΩÔ∏è Alimentation</option>
              <option value="petites-depenses">‚òï Petites d√©penses</option>
              <option value="vie-courante">üè† Vie courante</option>
              <option value="transport">üöó Transport</option>
              <option value="sante">üíä Sant√©</option>
              <option value="education">üìö √âducation</option>
              <option value="business">üíº Business</option>
              <option value="investissement">üí∞ Investissement</option>
              <option value="personnel">üëï Personnel</option>
              <option value="loisirs">üéÆ Loisirs</option>
              <option value="abonnements">üì± Abonnements</option>
              <option value="voyage">‚úàÔ∏è Voyage</option>
              <option value="dons">üéÅ Dons/Aides</option>
              <option value="autre">‚ùì Autre</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>üìù Description</label>
          <input type="text" id="motifInput" placeholder="D√©tails de la transaction" class="form-input">
        </div>

        <button onclick="addTransaction()" class="btn btn-primary">‚úÖ Enregistrer</button>
      </div>

      <div class="card">
        <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">Transactions r√©centes</h3>
        <div id="transactionsList" class="list-container"></div>
      </div>
    </div>

    <div id="pageDashboard" style="display: none;">
      <div class="banner purple">
        <h2>Dashboard Financier</h2>
        <p>Vue d'ensemble et analyses</p>
      </div>

      <div id="alertsContainer"></div>

      <div class="grid grid-3">
        <div class="stat-card">
          <div class="stat-header">
            <span class="text-gray">Total Entr√©es</span>
            <span style="font-size: 1.5rem;">üìà</span>
          </div>
          <div id="totalEntrees" class="stat-value text-green">0 FCFA</div>
          <div id="compareEntrees" style="font-size: 0.875rem; margin-top: 0.5rem; color: #6b7280;"></div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <span class="text-gray">Total Sorties</span>
            <span style="font-size: 1.5rem;">üìâ</span>
          </div>
          <div id="totalSorties" class="stat-value text-red">0 FCFA</div>
          <div id="compareSorties" style="font-size: 0.875rem; margin-top: 0.5rem; color: #6b7280;"></div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <span class="text-gray">Recette Nette</span>
            <span style="font-size: 1.5rem;">üí∞</span>
          </div>
          <div id="totalNet" class="stat-value text-blue">0 FCFA</div>
          <div id="compareNet" style="font-size: 0.875rem; margin-top: 0.5rem; color: #6b7280;"></div>
        </div>
      </div>

      <div class="card">
        <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">üìä D√©penses par Cat√©gorie</h3>
        <div id="categoriesStats"></div>
      </div>

      <div class="card">
        <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">üéØ R√©partition 40/10/10/20/10/10</h3>
        <div id="repartitionList"></div>
      </div>

      <div class="card">
        <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">üèÜ Top 3 D√©penses</h3>
        <div id="top3Depenses"></div>
      </div>
    </div>

    <div id="pageSettings" style="display: none;">
      <div class="banner gray">
        <h2>Param√®tres</h2>
        <p>Configuration</p>
      </div>

      <div class="card">
        <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">üí± Devise</h3>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
          <button onclick="setCurrency('FCFA')" class="btn-curr" data-curr="FCFA">FCFA</button>
          <button onclick="setCurrency('EUR')" class="btn-curr" data-curr="EUR">EUR</button>
          <button onclick="setCurrency('USD')" class="btn-curr" data-curr="USD">USD</button>
          <button onclick="setCurrency('GBP')" class="btn-curr" data-curr="GBP">GBP</button>
        </div>
        <div class="form-group">
          <label>Personnalis√©e :</label>
          <div style="display: flex; gap: 0.5rem;">
            <input type="text" id="customCurrency" placeholder="Ex: DZD" class="form-input">
            <button onclick="setCustomCurrency()" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer;">OK</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">üìä Statistiques</h3>
        <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
          <p style="font-weight: 600; margin-bottom: 0.5rem;">Total : <span id="transCount">0</span> transactions</p>
          <p style="font-weight: 600;">Synchronisation : ‚úÖ Cloud activ√©</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // ‚ö†Ô∏è REMPLACE LES XXXXX PAR TA VRAIE CL√â API (celle que tu m'as donn√©e)
    const firebaseConfig = {
      apiKey: "AIzaSyBSKB6Wc7Lr1bHx1wVxC9vTslfVxDwzdFo",
      authDomain: "suivi-finance-app.firebaseapp.com",
      projectId: "suivi-finance-app",
      storageBucket: "suivi-finance-app.firebasestorage.app",
      messagingSenderId: "66837585354",
      appId: "1:66837585354:web:4695946822f2f07016c333"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.auth = auth;
    window.db = db;
    window.collection = collection;
    window.addDoc = addDoc;
    window.getDocs = getDocs;
    window.deleteDoc = deleteDoc;
    window.doc = doc;
    window.query = query;
    window.where = where;
    window.orderBy = orderBy;
    window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword;
    window.signOut = signOut;

    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('mainApp').classList.add('show');
        document.getElementById('userEmail').textContent = user.email;
        init();
      } else {
        document.getElementById('authContainer').style.display = 'flex';
        document.getElementById('mainApp').classList.remove('show');
      }
    });
  </script>

  <script>
    let currency = 'FCFA';
    let transactions = [];

    const categories = {
      'alimentation': { name: 'üçΩÔ∏è Alimentation', color: '#10b981' },
      'petites-depenses': { name: '‚òï Petites d√©penses', color: '#f59e0b' },
      'vie-courante': { name: 'üè† Vie courante', color: '#3b82f6' },
      'transport': { name: 'üöó Transport', color: '#ef4444' },
      'sante': { name: 'üíä Sant√©', color: '#ec4899' },
      'education': { name: 'üìö √âducation', color: '#8b5cf6' },
      'business': { name: 'üíº Business', color: '#06b6d4' },
      'investissement': { name: 'üí∞ Investissement', color: '#14b8a6' },
      'personnel': { name: 'üëï Personnel', color: '#a855f7' },
      'loisirs': { name: 'üéÆ Loisirs', color: '#f97316' },
      'abonnements': { name: 'üì± Abonnements', color: '#6366f1' },
      'voyage': { name: '‚úàÔ∏è Voyage', color: '#0ea5e9' },
      'dons': { name: 'üéÅ Dons/Aides', color: '#f472b6' },
      'autre': { name: '‚ùì Autre', color: '#6b7280' }
    };

    function showLogin() {
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('signupForm').style.display = 'none';
    }

    function showSignup() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('signupForm').style.display = 'block';
    }

    async function signup() {
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      
      try {
        await window.createUserWithEmailAndPassword(window.auth, email, password);
      } catch (error) {
        document.getElementById('authError').textContent = 'Erreur : ' + error.message;
        document.getElementById('authError').style.display = 'block';
      }
    }

    async function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      try {
        await window.signInWithEmailAndPassword(window.auth, email, password);
      } catch (error) {
        document.getElementById('authError').textContent = 'Erreur : Email ou mot de passe incorrect';
        document.getElementById('authError').style.display = 'block';
      }
    }

    async function logout() {
      await window.signOut(window.auth);
    }

    async function init() {
      const saved = localStorage.getItem('currency');
      if (saved) currency = saved;
      
      document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
      updateCurrencyDisplay();
      await loadTransactions();
    }

    async function loadTransactions() {
      const user = window.auth.currentUser;
      if (!user) return;

      const q = window.query(
        window.collection(window.db, 'transactions'),
        window.where('userId', '==', user.uid),
        window.orderBy('date', 'desc')
      );

      const snapshot = await window.getDocs(q);
      transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      renderTransactions();
      updateDashboard();
    }

    async function addTransaction() {
      const entree = parseFloat(document.getElementById('entreeInput').value) || 0;
      const sortie = parseFloat(document.getElementById('sortieInput').value) || 0;
      const source = document.getElementById('sourceInput').value;
      const motif = document.getElementById('motifInput').value;
      const category = document.getElementById('categoryInput').value;
      const date = document.getElementById('dateInput').value;
      const recette = entree - sortie;

      const user = window.auth.currentUser;
      
      await window.addDoc(window.collection(window.db, 'transactions'), {
        userId: user.uid,
        date: date,
        entree: entree,
        source: source,
        sortie: sortie,
        motif: motif,
        category: category,
        recette: recette,
        createdAt: new Date().toISOString()
      });

      document.getElementById('entreeInput').value = '';
      document.getElementById('sourceInput').value = '';
      document.getElementById('sortieInput').value = '';
      document.getElementById('motifInput').value = '';
      document.getElementById('categoryInput').value = '';

      await loadTransactions();
    }

    async function deleteTransaction(id) {
      if (confirm('Supprimer ?')) {
        await window.deleteDoc(window.doc(window.db, 'transactions', id));
        await loadTransactions();
      }
    }

    function renderTransactions() {
      const list = document.getElementById('transactionsList');
      if (transactions.length === 0) {
        list.innerHTML = '<div class="empty-state">Aucune transaction</div>';
        return;
      }

      list.innerHTML = transactions.slice(0, 10).map(t => {
        const catInfo = categories[t.category] || { name: '', color: '#e5e7eb' };
        return `
        <div class="transaction-item" style="border-left-color: ${catInfo.color}">
          <div class="transaction-left">
            <div class="transaction-date">${new Date(t.date).toLocaleDateString('fr-FR')} ${t.recette < 0 ? '‚ö†Ô∏è' : ''}</div>
            <div class="transaction-detail">${t.source} ${t.motif}</div>
            ${t.category ? `<span class="transaction-category" style="background: ${catInfo.color}22; color: ${catInfo.color}">${catInfo.name}</span>` : ''}
          </div>
          <div class="transaction-right">
            ${t.entree > 0 ? `<div style="color: #16a34a; font-weight: bold;">+${t.entree.toLocaleString()}</div>` : ''}
            ${t.sortie > 0 ? `<div style="color: #dc2626; font-weight: bold;">-${t.sortie.toLocaleString()}</div>` : ''}
            <div style="font-weight: 600; color: ${t.recette >= 0 ? '#2563eb' : '#dc2626'}">${t.recette.toLocaleString()} ${currency}</div>
          </div>
          <button onclick="deleteTransaction('${t.id}')" class="transaction-delete">√ó</button>
        </div>
      `}).join('');
    }

    function updateDashboard() {
      const now = new Date();
      const thisMonth = transactions.filter(t => {
        const td = new Date(t.date);
        return td.getMonth() === now.getMonth() && td.getFullYear() === now.getFullYear();
      });

      const totalE = thisMonth.reduce((sum, t) => sum + t.entree, 0);
      const totalS = thisMonth.reduce((sum, t) => sum + t.sortie, 0);
      const net = totalE - totalS;

      document.getElementById('totalEntrees').textContent = `${totalE.toLocaleString()} ${currency}`;
      document.getElementById('totalSorties').textContent = `${totalS.toLocaleString()} ${currency}`;
      document.getElementById('totalNet').textContent = `${net.toLocaleString()} ${currency}`;
      document.getElementById('totalNet').className = `stat-value ${net >= 0 ? 'text-blue' : 'text-red'}`;

      renderAlerts(totalE, totalS, net);
      renderCategoryStats(thisMonth, totalS);
      renderRepartition(net);
      renderTop3(thisMonth);
      
      document.getElementById('transCount').textContent = transactions.length;
    }

    function renderAlerts(totalE, totalS, net) {
      const alerts = document.getElementById('alertsContainer');
      let html = '';

      if (net < 0) {
        html += '<div class="alert danger">‚ö†Ô∏è Attention ! Tes d√©penses d√©passent tes revenus</div>';
      } else if (net > 0 && totalE > 0) {
        const ratio = (net / totalE) * 100;
        if (ratio >= 30) {
          html += '<div class="alert success">üî• Excellent ! Tu √©pargnes ' + ratio.toFixed(0) + '% de tes revenus !</div>';
        }
      }

      if (totalS > totalE * 0.8 && totalE > 0) {
        html += '<div class="alert warning">‚ö° Tu as d√©pens√© 80% de tes revenus ce mois</div>';
      }

      alerts.innerHTML = html;
    }

    function renderCategoryStats(monthData, totalSorties) {
      const catStats = {};
      
      monthData.forEach(t => {
        if (t.sortie > 0 && t.category) {
          if (!catStats[t.category]) {
            catStats[t.category] = { total: 0, count: 0 };
          }
          catStats[t.category].total += t.sortie;
          catStats[t.category].count++;
        }
      });

      const sorted = Object.entries(catStats)
        .map(([cat, data]) => ({
          category: cat,
          total: data.total,
          count: data.count,
          percent: totalSorties > 0 ? (data.total / totalSorties * 100) : 0
        }))
        .sort((a, b) => b.total - a.total);

      const container = document.getElementById('categoriesStats');
      
      if (sorted.length === 0) {
        container.innerHTML = '<div class="empty-state">Aucune d√©pense cat√©goris√©e</div>';
        return;
      }

      container.innerHTML = sorted.map(item => {
        const catInfo = categories[item.category] || { name: item.category, color: '#6b7280' };
        return `
          <div class="category-stat" style="border-left-color: ${catInfo.color}">
            <div style="flex: 1;">
              <div style="font-weight: 600; margin-bottom: 0.25rem;">${catInfo.name}</div>
              <div style="font-size: 0.875rem; color: #6b7280;">${item.count} transaction(s) ‚Ä¢ ${item.percent.toFixed(1)}% du total</div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${item.percent}%; background: ${catInfo.color}"></div>
              </div>
            </div>
            <div style="font-size: 1.25rem; font-weight: bold; color: ${catInfo.color};">
              ${item.total.toLocaleString()} ${currency}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderRepartition(net) {
      const repartition = [
        { name: 'Compte Courant (40%)', value: net * 0.4 },
        { name: 'Investissement (10%)', value: net * 0.1 },
        { name: '√âpargne LT (10%)', value: net * 0.1 },
        { name: '√âducation (20%)', value: net * 0.2 },
        { name: 'Dons (10%)', value: net * 0.1 },
        { name: 'Libre (10%)', value: net * 0.1 }
      ];

      document.getElementById('repartitionList').innerHTML = repartition.map(r => `
        <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem; margin-bottom: 0.5rem;">
          <span style="font-weight: 600;">${r.name}</span>
          <span style="font-weight: bold;">${r.value.toLocaleString()} ${currency}</span>
        </div>
      `).join('');
    }

    function renderTop3(monthData) {
      const sorted = monthData
        .filter(t => t.sortie > 0)
        .sort((a, b) => b.sortie - a.sortie)
        .slice(0, 3);

      const container = document.getElementById('top3Depenses');
      
      if (sorted.length === 0) {
        container.innerHTML = '<div class="empty-state">Aucune d√©pense</div>';
        return;
      }

      const medals = ['ü•á', 'ü•à', 'ü•â'];
      
      container.innerHTML = sorted.map((t, i) => {
        const catInfo = t.category ? categories[t.category] : null;
        return `
          <div style="display: flex; align-items: center; padding: 1rem; background: #f9fafb; border-radius: 0.5rem; margin-bottom: 0.5rem;">
            <div style="font-size: 2rem; margin-right: 1rem;">${medals[i]}</div>
            <div style="flex: 1;">
              <div style="font-weight: 600;">${t.motif || t.source || 'Sans description'}</div>
              <div style="font-size: 0.875rem; color: #6b7280;">
                ${new Date(t.date).toLocaleDateString('fr-FR')}
                ${catInfo ? ` ‚Ä¢ ${catInfo.name}` : ''}
              </div>
            </div>
            <div style="font-size: 1.5rem; font-weight: bold; color: #dc2626;">
              ${t.sortie.toLocaleString()} ${currency}
            </div>
          </div>
        `;
      }).join('');
    }

    function showPage(page) {
      document.getElementById('pageSaisie').style.display = 'none';
      document.getElementById('pageDashboard').style.display = 'none';
      document.getElementById('pageSettings').style.display = 'none';
      
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      
      if (page === 'saisie') {
        document.getElementById('pageSaisie').style.display = 'block';
        document.getElementById('btnSaisie').classList.add('active');
      } else if (page === 'dashboard') {
        document.getElementById('pageDashboard').style.display = 'block';
        document.getElementById('btnDashboard').classList.add('active');
        updateDashboard();
      } else if (page === 'settings') {
        document.getElementById('pageSettings').style.display = 'block';
        document.getElementById('btnSettings').classList.add('active');
      }
    }

    function updateCurrencyDisplay() {
      document.getElementById('currencyDisplay').textContent = currency;
      document.querySelectorAll('.currency').forEach(el => el.textContent = currency);
      
      document.querySelectorAll('.btn-curr').forEach(btn => {
        if (btn.dataset.curr === currency) {
          btn.style.background = '#3b82f6';
          btn.style.color = 'white';
        } else {
          btn.style.background = '#f3f4f6';
          btn.style.color = '#374151';
        }
      });
    }

    function setCurrency(curr) {
      currency = curr;
      localStorage.setItem('currency', curr);
      updateCurrencyDisplay();
      renderTransactions();
      updateDashboard();
    }

    function setCustomCurrency() {
      const custom = document.getElementById('customCurrency').value.trim().toUpperCase();
      if (custom) {
        setCurrency(custom);
        document.getElementById('customCurrency').value = '';
      }
    }

    window.showLogin = showLogin;
    window.showSignup = showSignup;
    window.signup = signup;
    window.login = login;
    window.logout = logout;
    window.addTransaction = addTransaction;
    window.deleteTransaction = deleteTransaction;
    window.showPage = showPage;
    window.setCurrency = setCurrency;
    window.setCustomCurrency = setCustomCurrency;
  </script>

  <style>
    .btn-curr {
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-curr:hover {
      transform: translateY(-2px);
    }
  </style>
</body>
</html>
